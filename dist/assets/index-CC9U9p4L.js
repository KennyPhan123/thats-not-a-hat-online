var F=Object.defineProperty;var W=(s,e,t)=>e in s?F(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var c=(s,e,t)=>W(s,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(r){if(r.ep)return;r.ep=!0;const i=t(r);fetch(r.href,i)}})();const U="/cards/items/",L="/cards/backs/";function A(){const s=[];for(let e=1;e<=110;e++){const t=String(e).padStart(3,"0");s.push({id:`card_${t}`,front:`${U}card_${t}.png`,back:e<=55?`${L}back_black.png`:`${L}back_white.png`})}return s}function G(s){const e=[...s];for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}function j(s=4){const e="ABCDEFGHJKLMNPQRSTUVWXYZ";let t="";for(let n=0;n<s;n++)t+=e[Math.floor(Math.random()*e.length)];return t}function Y(s,e,t,n){const r=[],i=t/2,a=n/2,m=Math.min(t*.38,350),p=Math.min(n*.35,280),u=Math.PI/2;for(let h=0;h<s;h++){const d=(h+e)%s,_=u+h*2*Math.PI/s;r[d]={x:i+m*Math.cos(_),y:a+p*Math.sin(_),isCurrentPlayer:d===e}}return r}class J{constructor(){this.reset()}reset(){this.roomCode="",this.players=[],this.currentPlayerId=null,this.deck=[],this.isHost=!1,this.gameStarted=!1}initDeck(){const e=A();this.deck=G(e)}addPlayer(e){return this.players.length<8?(this.players.push({id:e.id,name:e.name,cards:[null,null],penalties:0}),!0):!1}removePlayer(e){this.players=this.players.filter(t=>t.id!==e)}getPlayer(e){return this.players.find(t=>t.id===e)}getCurrentPlayer(){return this.getPlayer(this.currentPlayerId)}drawCard(e){if(this.deck.length===0)return null;const t=this.getPlayer(e);if(!t)return null;const n=t.cards.findIndex(i=>i===null);if(n===-1)return null;const r=this.deck.pop();return r.isFlipped=!1,t.cards[n]=r,{card:r,slotIndex:n}}flipCard(e,t){const n=this.getPlayer(e);return!n||!n.cards[t]?!1:(n.cards[t].isFlipped=!n.cards[t].isFlipped,!0)}swapCards(e){const t=this.getPlayer(e);return t?([t.cards[0],t.cards[1]]=[t.cards[1],t.cards[0]],!0):!1}transferCard(e,t,n,r){const i=this.getPlayer(e),a=this.getPlayer(n);return!i||!a||!i.cards[t]||a.cards[r]!==null?!1:(a.cards[r]=i.cards[t],i.cards[t]=null,!0)}discardCard(e,t){const n=this.getPlayer(e);return!n||!n.cards[t]?!1:(n.cards[t]=null,n.penalties++,{penalties:n.penalties,gameOver:n.penalties>=3})}checkGameOver(){const e=this.players.find(t=>t.penalties>=3);return e||null}toJSON(){return{roomCode:this.roomCode,players:this.players,deck:this.deck,gameStarted:this.gameStarted}}fromJSON(e){this.roomCode=e.roomCode,this.players=e.players,this.deck=e.deck,this.gameStarted=e.gameStarted}}function q(s,e=!1){const t=document.createElement("div");t.className=`card${e?" large":""}${s.isFlipped?" flipped":""}`,t.dataset.cardId=s.id,t.draggable=!1;const n=document.createElement("div");n.className="card-inner";const r=document.createElement("div");r.className="card-face card-front",r.style.backgroundImage=`url(${s.front})`;const i=document.createElement("div");return i.className="card-face card-back",i.style.backgroundImage=`url(${s.back})`,n.appendChild(r),n.appendChild(i),t.appendChild(n),t}let E=0;function X(s,e){const t=n=>{const r=Date.now();r-E<300?(n.preventDefault(),e(),E=0):E=r};s.addEventListener("touchend",t),s.addEventListener("dblclick",n=>{n.preventDefault(),e()})}function Q(s,e,t){e.innerHTML="";const n=Y(s.players.length,s.players.findIndex(r=>r.id===s.currentPlayerId),window.innerWidth,window.innerHeight);s.players.forEach((r,i)=>{const a=n[i],m=z(r,a,s.currentPlayerId,t);e.appendChild(m)})}function z(s,e,t,n){const r=s.id===t,i=document.createElement("div");i.className=`player-slot${r?" current-player":""}`,i.dataset.playerId=s.id,i.style.left=`${e.x}px`,i.style.top=`${e.y}px`;const a=document.createElement("div");a.className="player-info";const m=document.createElement("span");if(m.className="player-name",m.textContent=s.name,a.appendChild(m),s.penalties>0){const u=document.createElement("span");u.className="player-penalty",u.textContent=`−${s.penalties}`,a.appendChild(u)}i.appendChild(a);const p=document.createElement("div");p.className="player-cards";for(let u=0;u<2;u++){const h=document.createElement("div");if(h.className="card-slot",h.dataset.slotIndex=u,s.cards[u]){h.classList.add("occupied");const d=q(s.cards[u],r);r&&n.onFlip&&X(d,()=>{n.onFlip(s.id,u)}),h.appendChild(d)}p.appendChild(h)}return i.appendChild(p),i}class K{constructor(e){this.container=e.container,this.onDragStart=e.onDragStart||(()=>{}),this.onDragMove=e.onDragMove||(()=>{}),this.onDragEnd=e.onDragEnd||(()=>{}),this.onDrop=e.onDrop||(()=>{}),this.isDragging=!1,this.dragElement=null,this.dragClone=null,this.startX=0,this.startY=0,this.offsetX=0,this.offsetY=0,this.dragData=null,this.bindEvents()}bindEvents(){this.container.addEventListener("mousedown",this.handleMouseDown.bind(this)),document.addEventListener("mousemove",this.handleMouseMove.bind(this)),document.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.container.addEventListener("touchstart",this.handleTouchStart.bind(this),{passive:!1}),document.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!1}),document.addEventListener("touchend",this.handleTouchEnd.bind(this))}getCardElement(e){return e.closest(".card")}handleMouseDown(e){const t=this.getCardElement(e.target);t&&(Date.now()-(t.lastTapTime||0)<300||this.startDrag(t,e.clientX,e.clientY))}handleTouchStart(e){if(e.touches.length!==1)return;const t=e.touches[0],n=this.getCardElement(t.target);n&&(n.touchStartTime=Date.now(),this.touchStartCard=n,this.dragTimeout=setTimeout(()=>{this.startDrag(n,t.clientX,t.clientY),e.preventDefault()},150))}startDrag(e,t,n){const r=e.getBoundingClientRect();this.isDragging=!0,this.dragElement=e,this.startX=t,this.startY=n,this.offsetX=t-r.left,this.offsetY=n-r.top,this.dragClone=e.cloneNode(!0),this.dragClone.className=e.className+" dragging",this.dragClone.style.position="fixed",this.dragClone.style.left=`${r.left}px`,this.dragClone.style.top=`${r.top}px`,this.dragClone.style.width=`${r.width}px`,this.dragClone.style.height=`${r.height}px`,this.dragClone.style.zIndex="9999",document.body.appendChild(this.dragClone),e.style.opacity="0.3";const i=e.closest(".card-slot"),a=e.closest(".player-slot");i&&a&&(this.dragData={cardId:e.dataset.cardId,fromPlayerId:a.dataset.playerId,fromSlot:parseInt(i.dataset.slotIndex)}),this.onDragStart(this.dragData)}handleMouseMove(e){this.isDragging&&this.moveDrag(e.clientX,e.clientY)}handleTouchMove(e){if(this.dragTimeout&&(clearTimeout(this.dragTimeout),this.dragTimeout=null),!this.isDragging||e.touches.length!==1)return;e.preventDefault();const t=e.touches[0];this.moveDrag(t.clientX,t.clientY)}moveDrag(e,t){this.dragClone&&(this.dragClone.style.left=`${e-this.offsetX}px`,this.dragClone.style.top=`${t-this.offsetY}px`,this.updateDropTargets(e,t),this.onDragMove(e,t,this.dragData))}updateDropTargets(e,t){document.querySelectorAll(".drag-over").forEach(r=>{r.classList.remove("drag-over")}),this.dragClone&&(this.dragClone.style.pointerEvents="none");const n=document.elementsFromPoint(e,t);this.dragClone&&(this.dragClone.style.pointerEvents="");for(const r of n){if(r.classList.contains("card-slot")&&!r.classList.contains("occupied")){r.classList.add("drag-over");break}if(r.classList.contains("penalty-zone")){r.classList.add("drag-over");break}}}handleMouseUp(e){this.isDragging&&this.endDrag(e.clientX,e.clientY)}handleTouchEnd(e){if(this.dragTimeout&&(clearTimeout(this.dragTimeout),this.dragTimeout=null),!this.isDragging)return;const t=e.changedTouches[0];this.endDrag(t.clientX,t.clientY)}endDrag(e,t){if(!this.isDragging)return;this.dragElement&&(this.dragElement.style.opacity=""),this.dragClone&&(this.dragClone.remove(),this.dragClone=null),document.querySelectorAll(".drag-over").forEach(i=>{i.classList.remove("drag-over")});const n=document.elementsFromPoint(e,t);let r=null;for(const i of n){if(i.classList.contains("penalty-zone")){r={type:"penalty"};break}if(i.classList.contains("card-slot")){const a=i.closest(".player-slot");r={type:"player",playerId:a==null?void 0:a.dataset.playerId,slotIndex:parseInt(i.dataset.slotIndex),isEmpty:!i.classList.contains("occupied")};break}}this.onDrop(this.dragData,r),this.onDragEnd(),this.isDragging=!1,this.dragElement=null,this.dragData=null}destroy(){}}(!globalThis.EventTarget||!globalThis.Event)&&console.error(`
  PartySocket requires a global 'EventTarget' class to be available!
  You can polyfill this global by adding this to your code before any partysocket imports: 
  
  \`\`\`
  import 'partysocket/event-target-polyfill';
  \`\`\`
  Please file an issue at https://github.com/partykit/partykit if you're still having trouble.
`);var O=class extends Event{constructor(e,t){super("error",t);c(this,"message");c(this,"error");this.message=e.message,this.error=e}},H=class extends Event{constructor(e=1e3,t="",n){super("close",n);c(this,"code");c(this,"reason");c(this,"wasClean",!0);this.code=e,this.reason=t}};const C={Event,ErrorEvent:O,CloseEvent:H};function V(s,e){if(!s)throw new Error(e)}function Z(s){return new s.constructor(s.type,s)}function ee(s){return"data"in s?new MessageEvent(s.type,s):"code"in s||"reason"in s?new H(s.code||1999,s.reason||"unknown reason",s):"error"in s?new O(s.error,s):new Event(s.type,s)}var M;const v=typeof process<"u"&&typeof((M=process.versions)==null?void 0:M.node)<"u"&&typeof document>"u"?ee:Z,g={maxReconnectionDelay:1e4,minReconnectionDelay:1e3+Math.random()*4e3,minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:Number.POSITIVE_INFINITY,maxEnqueuedMessages:Number.POSITIVE_INFINITY};let S=!1;var te=class f extends EventTarget{constructor(t,n,r={}){super();c(this,"_ws");c(this,"_retryCount",-1);c(this,"_uptimeTimeout");c(this,"_connectTimeout");c(this,"_shouldReconnect",!0);c(this,"_connectLock",!1);c(this,"_binaryType","blob");c(this,"_closeCalled",!1);c(this,"_messageQueue",[]);c(this,"_debugLogger",console.log.bind(console));c(this,"_url");c(this,"_protocols");c(this,"_options");c(this,"onclose",null);c(this,"onerror",null);c(this,"onmessage",null);c(this,"onopen",null);c(this,"_handleOpen",t=>{this._debug("open event");const{minUptime:n=g.minUptime}=this._options;clearTimeout(this._connectTimeout),this._uptimeTimeout=setTimeout(()=>this._acceptOpen(),n),V(this._ws,"WebSocket is not defined"),this._ws.binaryType=this._binaryType,this._messageQueue.forEach(r=>{var i;(i=this._ws)==null||i.send(r)}),this._messageQueue=[],this.onopen&&this.onopen(t),this.dispatchEvent(v(t))});c(this,"_handleMessage",t=>{this._debug("message event"),this.onmessage&&this.onmessage(t),this.dispatchEvent(v(t))});c(this,"_handleError",t=>{this._debug("error event",t.message),this._disconnect(void 0,t.message==="TIMEOUT"?"timeout":void 0),this.onerror&&this.onerror(t),this._debug("exec error listeners"),this.dispatchEvent(v(t)),this._connect()});c(this,"_handleClose",t=>{this._debug("close event"),this._clearTimeouts(),this._shouldReconnect&&this._connect(),this.onclose&&this.onclose(t),this.dispatchEvent(v(t))});this._url=t,this._protocols=n,this._options=r,this._options.startClosed&&(this._shouldReconnect=!1),this._options.debugLogger&&(this._debugLogger=this._options.debugLogger),this._connect()}static get CONNECTING(){return 0}static get OPEN(){return 1}static get CLOSING(){return 2}static get CLOSED(){return 3}get CONNECTING(){return f.CONNECTING}get OPEN(){return f.OPEN}get CLOSING(){return f.CLOSING}get CLOSED(){return f.CLOSED}get binaryType(){return this._ws?this._ws.binaryType:this._binaryType}set binaryType(t){this._binaryType=t,this._ws&&(this._ws.binaryType=t)}get retryCount(){return Math.max(this._retryCount,0)}get bufferedAmount(){return this._messageQueue.reduce((t,n)=>(typeof n=="string"?t+=n.length:n instanceof Blob?t+=n.size:t+=n.byteLength,t),0)+(this._ws?this._ws.bufferedAmount:0)}get extensions(){return this._ws?this._ws.extensions:""}get protocol(){return this._ws?this._ws.protocol:""}get readyState(){return this._ws?this._ws.readyState:this._options.startClosed?f.CLOSED:f.CONNECTING}get url(){return this._ws?this._ws.url:""}get shouldReconnect(){return this._shouldReconnect}close(t=1e3,n){if(this._closeCalled=!0,this._shouldReconnect=!1,this._clearTimeouts(),!this._ws){this._debug("close enqueued: no ws instance");return}if(this._ws.readyState===this.CLOSED){this._debug("close: already closed");return}this._ws.close(t,n)}reconnect(t,n){this._shouldReconnect=!0,this._closeCalled=!1,this._retryCount=-1,!this._ws||this._ws.readyState===this.CLOSED?this._connect():(this._disconnect(t,n),this._connect())}send(t){if(this._ws&&this._ws.readyState===this.OPEN)this._debug("send",t),this._ws.send(t);else{const{maxEnqueuedMessages:n=g.maxEnqueuedMessages}=this._options;this._messageQueue.length<n&&(this._debug("enqueue",t),this._messageQueue.push(t))}}_debug(...t){this._options.debug&&this._debugLogger("RWS>",...t)}_getNextDelay(){const{reconnectionDelayGrowFactor:t=g.reconnectionDelayGrowFactor,minReconnectionDelay:n=g.minReconnectionDelay,maxReconnectionDelay:r=g.maxReconnectionDelay}=this._options;let i=0;return this._retryCount>0&&(i=n*t**(this._retryCount-1),i>r&&(i=r)),this._debug("next delay",i),i}_wait(){return new Promise(t=>{setTimeout(t,this._getNextDelay())})}_getNextProtocols(t){if(!t)return Promise.resolve(null);if(typeof t=="string"||Array.isArray(t))return Promise.resolve(t);if(typeof t=="function"){const n=t();if(!n)return Promise.resolve(null);if(typeof n=="string"||Array.isArray(n))return Promise.resolve(n);if(n.then)return n}throw Error("Invalid protocols")}_getNextUrl(t){if(typeof t=="string")return Promise.resolve(t);if(typeof t=="function"){const n=t();if(typeof n=="string")return Promise.resolve(n);if(n.then)return n}throw Error("Invalid URL")}_connect(){if(this._connectLock||!this._shouldReconnect)return;this._connectLock=!0;const{maxRetries:t=g.maxRetries,connectionTimeout:n=g.connectionTimeout}=this._options;if(this._retryCount>=t){this._debug("max retries reached",this._retryCount,">=",t);return}this._retryCount++,this._debug("connect",this._retryCount),this._removeListeners(),this._wait().then(()=>Promise.all([this._getNextUrl(this._url),this._getNextProtocols(this._protocols||null)])).then(([r,i])=>{if(this._closeCalled){this._connectLock=!1;return}!this._options.WebSocket&&typeof WebSocket>"u"&&!S&&(console.error(`‼️ No WebSocket implementation available. You should define options.WebSocket. 

For example, if you're using node.js, run \`npm install ws\`, and then in your code:

import PartySocket from 'partysocket';
import WS from 'ws';

const partysocket = new PartySocket({
  host: "127.0.0.1:1999",
  room: "test-room",
  WebSocket: WS
});

`),S=!0);const a=this._options.WebSocket||WebSocket;this._debug("connect",{url:r,protocols:i}),this._ws=i?new a(r,i):new a(r),this._ws.binaryType=this._binaryType,this._connectLock=!1,this._addListeners(),this._connectTimeout=setTimeout(()=>this._handleTimeout(),n)}).catch(r=>{this._connectLock=!1,this._handleError(new C.ErrorEvent(Error(r.message),this))})}_handleTimeout(){this._debug("timeout event"),this._handleError(new C.ErrorEvent(Error("TIMEOUT"),this))}_disconnect(t=1e3,n){if(this._clearTimeouts(),!!this._ws){this._removeListeners();try{(this._ws.readyState===this.OPEN||this._ws.readyState===this.CONNECTING)&&this._ws.close(t,n),this._handleClose(new C.CloseEvent(t,n,this))}catch{}}}_acceptOpen(){this._debug("accept open"),this._retryCount=0}_removeListeners(){this._ws&&(this._debug("removeListeners"),this._ws.removeEventListener("open",this._handleOpen),this._ws.removeEventListener("close",this._handleClose),this._ws.removeEventListener("message",this._handleMessage),this._ws.removeEventListener("error",this._handleError))}_addListeners(){this._ws&&(this._debug("addListeners"),this._ws.addEventListener("open",this._handleOpen),this._ws.addEventListener("close",this._handleClose),this._ws.addEventListener("message",this._handleMessage),this._ws.addEventListener("error",this._handleError))}_clearTimeouts(){clearTimeout(this._connectTimeout),clearTimeout(this._uptimeTimeout)}};const se=s=>s[1]!==null&&s[1]!==void 0;function ne(){if(crypto!=null&&crypto.randomUUID)return crypto.randomUUID();let s=Date.now(),e=(performance==null?void 0:performance.now)&&performance.now()*1e3||0;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){let n=Math.random()*16;return s>0?(n=(s+n)%16|0,s=Math.floor(s/16)):(n=(e+n)%16|0,e=Math.floor(e/16)),(t==="x"?n:n&3|8).toString(16)})}function R(s,e,t={}){const{host:n,path:r,protocol:i,room:a,party:m,basePath:p,prefix:u,query:h}=s;let d=n.replace(/^(http|https|ws|wss):\/\//,"");if(d.endsWith("/")&&(d=d.slice(0,-1)),r!=null&&r.startsWith("/"))throw new Error("path must not start with a slash");const _=m??"main",b=r?`/${r}`:"",w=i||(d.startsWith("localhost:")||d.startsWith("127.0.0.1:")||d.startsWith("192.168.")||d.startsWith("10.")||d.startsWith("172.")&&d.split(".")[1]>="16"&&d.split(".")[1]<="31"||d.startsWith("[::ffff:7f00:1]:")?e:`${e}s`),I=`${w}://${d}/${p||`${u||"parties"}/${_}/${a}`}${b}`,k=(B={})=>`${I}?${new URLSearchParams([...Object.entries(t),...Object.entries(B).filter(se)])}`,$=typeof h=="function"?async()=>k(await h()):k(h);return{host:d,path:b,room:a,name:_,protocol:w,partyUrl:I,urlProvider:$}}var re=class extends te{constructor(e){var n,r;const t=x(e);super(t.urlProvider,t.protocols,t.socketOptions);c(this,"_pk");c(this,"_pkurl");c(this,"name");c(this,"room");c(this,"host");c(this,"path");this.partySocketOptions=e,this.setWSProperties(t),e.disableNameValidation||((n=e.party)!=null&&n.includes("/")&&console.warn(`PartySocket: party name "${e.party}" contains forward slash which may cause routing issues. Consider using a name without forward slashes or set disableNameValidation: true to bypass this warning.`),(r=e.room)!=null&&r.includes("/")&&console.warn(`PartySocket: room name "${e.room}" contains forward slash which may cause routing issues. Consider using a name without forward slashes or set disableNameValidation: true to bypass this warning.`))}updateProperties(e){const t=x({...this.partySocketOptions,...e,host:e.host??this.host,room:e.room??this.room,path:e.path??this.path});this._url=t.urlProvider,this._protocols=t.protocols,this._options=t.socketOptions,this.setWSProperties(t)}setWSProperties(e){const{_pk:t,_pkurl:n,name:r,room:i,host:a,path:m}=e;this._pk=t,this._pkurl=n,this.name=r,this.room=i,this.host=a,this.path=m}reconnect(e,t){if(!this.room||!this.host)throw new Error("The room and host must be set before connecting, use `updateProperties` method to set them or pass them to the constructor.");super.reconnect(e,t)}get id(){return this._pk}get roomUrl(){return this._pkurl}static async fetch(e,t){const n=R(e,"http"),r=typeof n.urlProvider=="string"?n.urlProvider:await n.urlProvider();return(e.fetch??fetch)(r,t)}};function x(s){const{id:e,host:t,path:n,party:r,room:i,protocol:a,query:m,protocols:p,...u}=s,h=e||ne(),d=R(s,"ws",{_pk:h});return{_pk:h,_pkurl:d.partyUrl,name:d.name,room:d.room,host:d.host,path:d.path,protocols:p,socketOptions:u,urlProvider:d.urlProvider}}const oe="thats-not-a-hat-server.kennyphan123.partykit.dev",o={socket:null,playerId:null,playerName:"",roomCode:"",isHost:!1,gameState:new J,dragHandler:null,discardHistory:[]},l={lobby:document.getElementById("lobby"),game:document.getElementById("game"),mainMenu:document.getElementById("mainMenu"),showCreate:document.getElementById("showCreate"),showJoin:document.getElementById("showJoin"),createForm:document.getElementById("createForm"),joinForm:document.getElementById("joinForm"),createName:document.getElementById("createName"),joinName:document.getElementById("joinName"),roomCode:document.getElementById("roomCode"),createRoom:document.getElementById("createRoom"),joinRoom:document.getElementById("joinRoom"),roomInfo:document.getElementById("roomInfo"),displayRoomCode:document.getElementById("displayRoomCode"),playerCount:document.getElementById("playerCount"),playerList:document.getElementById("playerList"),startGame:document.getElementById("startGame"),waitingText:document.querySelector(".waiting-text"),gameTable:document.getElementById("gameTable"),deck:document.getElementById("deck"),playersContainer:document.getElementById("playersContainer"),penaltyZone:document.getElementById("penaltyZone"),gameOverModal:document.getElementById("gameOverModal"),gameOverMessage:document.getElementById("gameOverMessage"),playAgain:document.getElementById("playAgain")};function ie(){ae(),me(),window.addEventListener("resize",()=>{o.gameState.gameStarted&&y()})}function ae(){var s,e,t;l.showCreate.addEventListener("click",()=>{l.mainMenu.classList.add("hidden"),l.createForm.classList.remove("hidden")}),l.showJoin.addEventListener("click",()=>{l.mainMenu.classList.add("hidden"),l.joinForm.classList.remove("hidden")}),l.createRoom.addEventListener("click",()=>{const n=l.createName.value.trim();if(!n){alert("Please enter your name");return}o.playerName=n,o.roomCode=j(4),o.isHost=!0,T()}),l.joinRoom.addEventListener("click",()=>{const n=l.joinName.value.trim(),r=l.roomCode.value.trim().toUpperCase();if(!n){alert("Please enter your name");return}if(!r||r.length!==4){alert("Please enter 4-letter room code");return}o.playerName=n,o.roomCode=r,o.isHost=!1,T()}),l.startGame.addEventListener("click",()=>{o.socket&&o.isHost&&o.socket.send(JSON.stringify({type:"start"}))}),(s=document.getElementById("backFromCreate"))==null||s.addEventListener("click",()=>{l.createForm.classList.add("hidden"),l.mainMenu.classList.remove("hidden")}),(e=document.getElementById("backFromJoin"))==null||e.addEventListener("click",()=>{l.joinForm.classList.add("hidden"),l.mainMenu.classList.remove("hidden")}),(t=document.getElementById("copyCodeBtn"))==null||t.addEventListener("click",le)}function le(){const s=l.displayRoomCode.textContent,e=document.getElementById("copyCodeBtn");navigator.clipboard.writeText(s).then(()=>{e.textContent="Copied!",setTimeout(()=>{e.textContent="Tap to Copy"},2e3)}).catch(()=>{const t=document.createElement("textarea");t.value=s,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),e.textContent="Copied!",setTimeout(()=>{e.textContent="Tap to Copy"},2e3)})}function T(){o.socket=new re({host:oe,room:o.roomCode}),o.socket.addEventListener("open",()=>{o.playerId=o.socket.id,o.socket.send(JSON.stringify({type:"join",name:o.playerName})),ce()}),o.socket.addEventListener("message",s=>{de(JSON.parse(s.data))}),o.socket.addEventListener("error",s=>{console.error("Connection error:",s),alert("Cannot connect to server. Make sure PartyKit is running.")}),o.socket.addEventListener("close",()=>{alert("Disconnected from server"),location.reload()})}function ce(){l.displayRoomCode.textContent=o.roomCode,l.roomInfo.classList.remove("hidden"),l.mainMenu.classList.add("hidden"),l.createForm.classList.add("hidden"),l.joinForm.classList.add("hidden")}function N(){const s=o.gameState.players;l.playerCount.textContent=s.length,l.playerList.innerHTML=s.map(e=>`<span class="player-tag${e.id===o.gameState.hostId?" host":""}">${e.name}${e.id===o.gameState.hostId?" (Host)":""}</span>`).join(""),o.isHost&&s.length>=2?(l.startGame.classList.remove("hidden"),l.waitingText.classList.add("hidden")):o.isHost||l.waitingText.classList.remove("hidden")}function de(s){switch(console.log("Server:",s.type,s),s.type){case"state":o.gameState.players=s.state.players||[],o.gameState.deck=s.state.deck||[],o.gameState.hostId=s.state.hostId,o.gameState.gameStarted=s.state.gameStarted,s.state.gameStarted&&P();break;case"playerJoined":o.gameState.players=s.players,o.gameState.hostId=s.hostId,s.hostId===o.playerId&&(o.isHost=!0),N();break;case"playerLeft":o.gameState.players=s.players,s.hostId===o.playerId&&(o.isHost=!0),N(),o.gameState.gameStarted&&y();break;case"gameStarted":o.gameState.deck=s.deck,o.gameState.players=s.players,o.gameState.gameStarted=!0,P();break;case"cardDrawn":_e(s);break;case"cardFlipped":ve(s);break;case"cardMoved":o.gameState.players=s.players,y();break;case"cardsSwapped":Ee(s);break;case"cardDiscarded":Ce(s);break;case"gameReset":o.gameState.deck=s.deck,o.gameState.players=s.players,o.discardHistory=s.discardHistory||[],l.gameOverModal.classList.add("hidden"),y();break;case"error":alert(s.message);break}}function P(){l.lobby.classList.remove("active"),l.game.classList.add("active"),o.gameState.currentPlayerId=o.playerId,he(),y()}function he(){o.dragHandler=new K({container:l.gameTable,onDrop:fe})}function y(){ue(),Q(o.gameState,l.playersContainer,{onFlip:ge})}function ue(){const s=l.deck,e=s.querySelector(".deck-cards"),t=s.querySelector(".deck-count");e.innerHTML="";const n=o.gameState.deck;if(n.length>0){const r=Math.min(n.length,5);for(let i=r-1;i>=0;i--){const a=document.createElement("div");a.className="deck-card";const m=n.length-1-i;n[m]&&(a.style.backgroundImage=`url(${n[m].front})`),a.style.top=`${-i*2}px`,a.style.left=`${i*1}px`,a.style.zIndex=r-i,e.appendChild(a)}}t.textContent=n.length,s.onclick=()=>{o.socket&&n.length>0&&o.socket.send(JSON.stringify({type:"draw"}))},s.style.display=n.length>0?"":"none"}function me(){var s;(s=l.playAgain)==null||s.addEventListener("click",()=>{o.socket&&o.socket.send(JSON.stringify({type:"reset"}))}),pe()}function pe(){l.penaltyZone.addEventListener("click",s=>{s.target.closest(".card")||ye()})}function ye(){let s=document.getElementById("discardHistoryModal");if(s){s.classList.toggle("hidden"),s.classList.contains("hidden")||D();return}s=document.createElement("div"),s.id="discardHistoryModal",s.className="modal",s.innerHTML=`
        <div class="modal-content discard-history-modal">
            <h2>Discard History</h2>
            <div id="discardHistoryList" class="discard-history-list"></div>
            <button id="closeDiscardHistory" class="btn btn-secondary">Close</button>
        </div>
    `,document.body.appendChild(s),document.getElementById("closeDiscardHistory").addEventListener("click",()=>{s.classList.add("hidden")}),s.addEventListener("click",e=>{e.target===s&&s.classList.add("hidden")}),D()}function D(){const s=document.getElementById("discardHistoryList");if(s){if(o.discardHistory.length===0){s.innerHTML='<p class="no-discards">No cards discarded yet</p>';return}s.innerHTML=o.discardHistory.map((e,t)=>`
        <div class="discard-item">
            <div class="discard-card" style="background-image: url(${e.card.front})"></div>
            <span class="discard-player">${e.playerName}</span>
        </div>
    `).join("")}}function ge(s,e){s===o.playerId&&o.socket&&o.socket.send(JSON.stringify({type:"flip",slotIndex:e}))}function fe(s,e){!s||!e||(e.type==="penalty"?s.fromPlayerId===o.playerId&&o.socket&&o.socket.send(JSON.stringify({type:"discard",playerId:s.fromPlayerId,slotIndex:s.fromSlot})):e.type==="player"&&(e.playerId===s.fromPlayerId?s.fromSlot!==e.slotIndex&&o.socket&&o.socket.send(JSON.stringify({type:"swapCards",playerId:s.fromPlayerId})):e.playerId===o.playerId&&e.isEmpty?o.socket&&o.socket.send(JSON.stringify({type:"moveCard",fromPlayerId:s.fromPlayerId,fromSlot:s.fromSlot,toPlayerId:e.playerId,toSlot:e.slotIndex})):s.fromPlayerId===o.playerId&&e.isEmpty&&o.socket&&o.socket.send(JSON.stringify({type:"moveCard",fromPlayerId:s.fromPlayerId,fromSlot:s.fromSlot,toPlayerId:e.playerId,toSlot:e.slotIndex}))))}function _e(s){o.gameState.deck.pop(),s.players&&(o.gameState.players=s.players),y()}function ve(s){const e=o.gameState.players.find(t=>t.id===s.playerId);e&&e.cards[s.slotIndex]&&(e.cards[s.slotIndex].isFlipped=s.isFlipped),y()}function Ee(s){const e=o.gameState.players.find(t=>t.id===s.playerId);e&&(e.cards=s.cards),y()}function Ce(s){s.players&&(o.gameState.players=s.players),s.discardHistory&&(o.discardHistory=s.discardHistory),y(),s.gameOver&&be(s.loserName)}function be(s){l.gameOverMessage.textContent=`${s} got 3 penalties and lost!`,l.gameOverModal.classList.remove("hidden")}ie();
